package com.naver.client.controller;

import org.modelmapper.ModelMapper;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.messaging.handler.annotation.MessageMapping;
import org.springframework.messaging.simp.SimpMessageSendingOperations;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestHeader;
import org.springframework.web.bind.annotation.RestController;

import com.naver.client.common.JwtTokenProvider;
import com.naver.client.dto.MessageDto;
import com.naver.client.mapper.ChatMessage;
import com.naver.client.service.ChatMessageService;

@RestController
public class ChatContoller {
	@Autowired
	JwtTokenProvider jwtTokenProvider;
	
	@Autowired
	ModelMapper modelMapper;
	
	@Autowired
	private SimpMessageSendingOperations messaginTemplate;
	
	@Autowired
	private ChatMessageService chatMessageService;
	
	/*
	 * 채팅방 참여
	 */
	@MessageMapping("/chat/join")
	public void chatJoin() {
		
	}
	
	/*
	 * 채팅방 나가기
	 */
	@MessageMapping("/chat/exit")
	public void chatExit() {
		
	}
	
	/*
	 * 일반 메시지 전송
	 */
	 @MessageMapping("/chat/message")
	 public void sendMessage(MessageDto messageDto,@Header("Authorization")String token) {
		 int userId = Integer.parseInt(jwtTokenProvider.getUserNameFromJwt(token));
		 ChatMessage chatMessage = modelMapper.map(messageDto, ChatMessage.class);
		 chatMessage.setUserId(userId);
		 /*
		  * db 에 저장한다.
		  */
		 chatMessageService.insert(chatMessage);
		 
		 /*
		  * 소켓에 넣어둔다.
		  */
		 messaginTemplate.convertAndSend("/sub/chat/rooms/" + chatMessage.getChatId(),chatMessage);
	 }
	
}
